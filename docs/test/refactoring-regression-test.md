# 🧪 リファクタリング動作確認書（完全版）

## 概要
- **目的**: テンプレート分割（`th:replace`）およびフォーム統合に伴う既存機能の動作保証（回帰テスト）
- **対象**: Hacker Mode / Casual Mode 全般
- **重点項目**: Sort / Text / Shuffle（Choice・Click含む）
- **実施環境**: Chrome（必須）、Safari / Firefox（任意）
- **使用ツール**: ブラウザ DevTools（Network / Console / Elements）

---

## 0. 実施ルール
- **判定基準**
  - ✅ Pass : 期待どおりの動作
  - ⚠️ Warn : 仕様未確定・軽微な崩れ（要記録）
  - ❌ Fail : 500エラー、進行不能、スコア・状態破綻、セキュリティ上の問題
- **記録項目**
  - URL / 問題ID / 操作手順 / 実際の挙動 / Console・Networkログ（可能ならスクショ）

---

## 1. 共通チェック項目（Common）

### 1-1. 基本遷移・送信・例外
- [ ] 正常な回答送信でエラー画面にならず判定画面へ遷移する
- [ ] 不正入力（空・無効値）でも500にならず仕様どおり処理される
- [ ] Whitelabel Error Page が表示されない
- [ ] 判定URLをGET直叩きしても500にならない（405/リダイレクト等）

### 1-2. CSRF / HTTP / ルーティング
- [ ] POST送信が403（CSRF）にならない
- [ ] formのaction / methodが想定どおり
- [ ] Back / Reloadで二重送信・二重加点が起きない

### 1-3. Hidden ID / 送信データ
- [ ] hidden id が送信され、現在の問題IDと一致する
- [ ] idを存在しない数値に改ざんしても500にならない
- [ ] idを文字列（例: abc）にしても500にならない
- [ ] 別問題のidを送っても進行・スコアが破綻しない

### 1-4. 入力値正規化（Text系）
- [ ] 前後スペースを含む入力でも想定どおり判定される
- [ ] 大文字・小文字の違いが想定どおり扱われる
- [ ] 全角・半角の違いが想定どおり扱われる
- [ ] 改行・タブを含んでも500にならない
- [ ] 空文字・スペースのみでも500にならない

### 1-5. 連打・多重送信耐性
- [ ] EXECUTE / Enter連打でも判定が二重に走らない
- [ ] Choice / Click連打で二重進行・二重加点が起きない
- [ ] 判定後に戻って再送信しても破綻しない

---

## 2. Shuffle（ランダム表示）

### 2-1. シャッフル有効（Choice / Click）
- [ ] リロードごとに表示順が変わる
- [ ] 表示順が変わっても正解判定が壊れない
- [ ] 戻る操作後も状態が破綻しない

### 2-2. シャッフル無効（順序重要）
- [ ] 順序が固定されている（リロードしても変わらない）
- [ ] 意図しないシャッフルが発生しない

### 2-3. 異常系（Options）
- [ ] options = null でも500にならず画面が表示される
- [ ] options = empty でも500にならず画面が表示される
- [ ] options内にnull要素があっても500にならない（可能なら）

---

## 3. Hacker Mode

### 3-1. 表示・テンプレ展開
- [ ] `th:replace` 展開後にCSS崩れがない
- [ ] `<form>` の中に `<form>` が存在しない
- [ ] 同一ページに重複したid属性が存在しない

### 3-2. タイプ別動作（Hacker）

| タイプ | チェック内容 | 確認 |
|:---:|---|:---:|
| Sort | ドラッグ＆ドロップで並べ替えできる | [ ] |
| Sort | 未操作でも送信できる／仕様どおりエラー | [ ] |
| Sort | 送信データに欠落・重複がない | [ ] |
| Sort | 連打しても二重判定にならない | [ ] |
| Select | プルダウンで選択して送信できる | [ ] |
| Click | クリックで判定画面へ遷移する | [ ] |
| Text | Enter / EXECUTE で送信できる | [ ] |
| Text | Enterが意図しないformをsubmitしない | [ ] |
| ImageMap | 正解/不正解エリア判定が正しい | [ ] |
| Story | 次のミッションへ正しく遷移する | [ ] |
| Story | 戻る操作でも進行が破綻しない | [ ] |

---

## 4. Casual Mode

### 4-1. 入力エリア制御（quiz_input_area）
- [ ] Textは入力欄＋送信ボタンが表示される
- [ ] Choiceは入力欄が表示されない
- [ ] Longpressは入力欄が表示されない
- [ ] Lights / Keyboard は標準送信ボタンが非表示
- [ ] Text表示時、入力欄に初期フォーカスが当たる

### 4-2. 進行・状態
- [ ] Back / Reloadで進行が破綻しない
- [ ] 再挑戦時の状態が仕様どおり

---

## 5. 🛠 技術的検証（How-to）

### 5-1. Hidden ID & Payload 確認
**目的**: フォーム統合後の送信データ保証  
**手順**
1. DevTools → Network
2. 回答送信
3. Request Body / Payload を確認

**期待値**
- id: 現在の問題ID
- answer: 入力値・選択値・Sort結果
- 想定外パラメータが含まれていない

---

### 5-2. Sort機能のJS連携
**目的**: form統合後のJS参照ミス検知  
**手順**
1. Sort問題画面を開く
2. Consoleエラーがないか確認
3. D&D → 決定して回答

**期待値**
- Consoleエラーなし
- 正しく判定画面へ遷移

---

### 5-3. Options異常注入テスト
**目的**: View崩壊・500防止  
**手順**
- Controllerで一時的に options = null / empty を注入

**期待値**
- 500にならない
- 画面が成立する（仕様どおり）

---

### 5-4. 二重送信テスト
**目的**: 二重判定・二重加点防止  
**手順**
- EXECUTE / Choice / Sort決定を高速連打

**期待値**
- 判定は1回のみ
- スコア・進行が1回分だけ反映

---

## 6. 任意チェック
- [ ] Safari / Firefox で致命的な崩れがない
- [ ] スマホ操作でSortが破綻しない（非対応なら明記）
- [ ] Tab + Enter で操作できる（可能な範囲）

---

## 7. 受け入れ基準
- 500 / Whitelabel Error Page が **ゼロ**
- CSRF / 403 が **ゼロ**
- 二重送信で進行・スコアが破綻しない
- Sort / Text / Shuffle の重点項目がすべて Pass
- Hidden ID 改ざんでも 500 にならず仕様どおり処理される
