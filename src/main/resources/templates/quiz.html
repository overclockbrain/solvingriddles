<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{common/head :: common-head('Level ' + ${riddle.id})}"></head>
<body>
    <header th:replace="~{common/header :: common-header}"></header>

    <div class="container">
        <h2 th:text="'LEVEL ' + ${riddle.id} + ': SECURITY CHECK'">LEVEL X</h2>
        <p>セキュリティ・質問に回答せよ</p>
        
        <h3 class="question-text"
            th:utext="${#strings.replace(riddle.question, '&#10;', '<br>')}">
        </h3>
        
        <p class="hint-text"
        th:text="'HINT: ' + ${riddle.hint}">
        </p>

        <!-- 画像マップ型の問題表示 -->
        <div th:if="${riddle.type == 'image-map'}" class="image-quiz-area">
            <img th:src="@{${riddle.imageUrl}}" usemap="#image-map" 
                class="puzzle-image">

            <map name="image-map">
                <area shape="rect" th:coords="${riddle.coords}" 
                    th:href="@{/quiz/check-image(id=${riddle.id}, answer=${riddle.answer})}"
                    alt="正解エリア">
                
                <area shape="rect" coords="0,0,3000,3000" 
                    th:href="@{/quiz/check-image(id=${riddle.id}, answer='wrong')}"
                    alt="不正解エリア">
            </map>
        </div>

        <!-- ストーリー型の問題表示 -->
        <div th:if="${riddle.type == 'story'}" class="story-container">
            <div class="story-btn-container">
                <a th:href="@{/list}" class="btn btn-secondary">一覧へ</a>
                <a th:if="${riddle.nextId != null}" 
                th:href="@{/quiz/{id}(id=${riddle.nextId})}" 
                class="btn">次のミッションへ</a>
            </div>
        </div>

        <!-- セレクト型の問題表示 -->
        <div th:if="${riddle.type == 'select'}" class="select-container">
            <form th:action="@{/quiz/check}" method="post" class="quiz-form">
                <input type="hidden" name="id" th:value="${riddle.id}">
                
                <div style="margin: 20px 0;">
                    <select name="answer" class="form-select" required>
                        <option value="" selected disabled>-- 言語を選択 --</option>
                        <option th:each="opt : ${riddle.options}"
                                th:value="${opt.role}"
                                th:text="${opt.text}">
                        </option>
                    </select>
                </div>

                <button type="submit" class="btn">ロック解除</button>
            </form>
        </div>

        <!-- 並べ替え型の問題表示 -->
        <div th:if="${riddle.type == 'sort'}" class="sort-container">
            <ul id="sortable-list" class="sort-list">
                <li th:each="opt : ${riddle.options}"
                    class="sort-item"
                    draggable="true"
                    th:data-value="${opt.role}"
                    th:text="${opt.text}">
                </li>
            </ul>

            <form th:action="@{/quiz/check}" method="post" id="sortForm">
                <input type="hidden" name="id" th:value="${riddle.id}">
                <input type="hidden" name="answer" id="hiddenAnswer">
                <div style="text-align: center; margin-top: 20px;">
                    <button type="button" class="btn" onclick="submitSortAnswer()">決定して回答</button>
                </div>
            </form>
        </div>

        <!-- テキスト入力型・クリック型の問題表示 -->
        <form id="quizForm" th:action="@{/quiz/check}" method="post" 
          th:unless="${riddle.type == 'image-map' || riddle.type == 'story' || riddle.type == 'select'}">
            <input type="hidden" name="id" th:value="${riddle.id}" />

            <!-- テキスト入力型の問題表示 -->
            <div th:if="${riddle.type == 'text'}">
                <input type="text" name="answer" placeholder="Enter key..." autofocus>
                <button type="submit">EXECUTE</button>
            </div>

            <!-- クリック型の問題表示 -->
            <div th:if="${riddle.type == 'click'}" class="click-area" th:classappend="'level-' + ${riddle.id}">
                <input type="hidden" id="hiddenAnswer" name="answer" value="">

                <th:block th:each="opt : ${riddle.options}">
                    
                    <span th:if="${opt.role == 'target'}" 
                          class="target-char" 
                          th:text="${opt.text}"
                          onclick="submitAnswer('found')"></span>

                    <span th:if="${opt.role == 'fake'}" 
                          class="fake-char" 
                          th:text="${opt.text}"
                          onclick="submitAnswer('wrong')"></span>

                    <span th:if="${opt.role == 'normal'}" 
                          th:text="${opt.text}"></span>
                          
                </th:block>

                <script>
                    function submitAnswer(val) {
                        document.getElementById('hiddenAnswer').value = val;
                        document.getElementById('quizForm').submit();
                    }
                </script>
            </div>
        </form>
        
        <br><br><br>
        <!-- 中断リンク（ストーリー型以外で表示） -->
        <div th:if="${riddle.type != 'story'}">
            <a th:href="@{/list}">&lt;&lt; Abort (List)</a>
        </div>
    </div>

    <script th:src="@{/js/script.js}"></script>
</body>
</html>